#!/usr/bin/env bash
set -e

KAFKA_CONTAINER_NAME="local-kafka"
IMAGE="confluentinc/cp-kafka:latest"
BOOTSTRAP_SERVER="localhost:9092"

# Stop existing container if running
if docker ps -a --format '{{.Names}}' | grep -q "^${KAFKA_CONTAINER_NAME}$"; then
  docker rm -f ${KAFKA_CONTAINER_NAME} >/dev/null
fi

docker run -d \
  --name ${KAFKA_CONTAINER_NAME} \
  -p 9092:9092 \
  -e KAFKA_ENABLE_KRAFT=yes \
  -e KAFKA_CFG_NODE_ID=1 \
  -e KAFKA_CFG_PROCESS_ROLES=broker,controller \
  -e KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@localhost:9093 \
  -e KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093 \
  -e KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://${BOOTSTRAP_SERVER} \
  -e KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT \
  -e KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER \
  -e KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true \
  -e ALLOW_PLAINTEXT_LISTENER=yes \
  ${IMAGE} >/dev/null

# Wait briefly for Kafka startup
sleep 10

# Export and output bootstrap server
export KAFKA_BOOTSTRAP_SERVER="${BOOTSTRAP_SERVER}"
echo "${KAFKA_BOOTSTRAP_SERVER}"
